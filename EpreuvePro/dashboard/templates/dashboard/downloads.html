{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Mes t√©l√©chargements - EpreuvesPro{% endblock %}
{% block dashboard_title %}üì• Mes t√©l√©chargements{% endblock %}
{% block dashboard_subtitle %}Historique de tes √©preuves et corrig√©s{% endblock %}

{% block extra_css %}
<style>
    .downloads-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .downloads-stats {
        display: flex;
        gap: 1rem;
    }
    
    .stat-pill {
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        color: #64748B;
    }
    
    .stat-pill strong {
        color: #1e293b;
    }
    
    .filter-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .filter-select,
    .search-input {
        padding: 0.625rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 0.875rem;
        background: white;
    }
    
    .search-input {
        min-width: 250px;
    }
    
    .downloads-list {
        background: white;
        border-radius: 16px;
        overflow: hidden;
    }
    
    .download-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem;
        border-bottom: 1px solid #f1f5f9;
        transition: background 0.2s;
    }
    
    .download-item:last-child {
        border-bottom: none;
    }
    
    .download-item:hover {
        background: #f8fafc;
    }
    
    .download-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #FF6B35 0%, #F7C548 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .download-icon.corrige {
        background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    
    .download-info {
        flex: 1;
    }
    
    .download-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .download-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: #64748B;
        flex-wrap: wrap;
    }
    
    .download-meta span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .download-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.625rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .download-badge.free {
        background: #f1f5f9;
        color: #64748B;
    }
    
    .download-badge.premium {
        background: #fef3c7;
        color: #92400e;
    }
    
    .download-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .btn-icon:hover {
        background: #f1f5f9;
        border-color: #FF6B35;
    }
    
    .btn-icon.primary {
        background: #FF6B35;
        border-color: #FF6B35;
        color: white;
    }
    
    .btn-icon.primary:hover {
        background: #E55A2B;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 16px;
    }
    
    .empty-icon {
        width: 80px;
        height: 80px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        margin: 0 auto 1.5rem;
    }
    
    .empty-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
    }
    
    .empty-text {
        color: #64748B;
        margin-bottom: 1.5rem;
    }
    
    /* Monthly Stats */
    .month-section {
        margin-bottom: 1.5rem;
    }
    
    .month-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }
    
    .month-title {
        font-weight: 600;
        color: #1e293b;
    }
    
    .month-count {
        background: #f1f5f9;
        color: #64748B;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }
    
    .page-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .page-btn:hover,
    .page-btn.active {
        background: #FF6B35;
        border-color: #FF6B35;
        color: white;
    }
    
    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="downloads-header">
    <div class="downloads-stats">
        <div class="stat-pill">
            <strong>{{ total_downloads }}</strong> total
        </div>
        <div class="stat-pill">
            <strong>{{ downloads_this_month }}</strong> ce mois
        </div>
        {% if is_premium %}
        <div class="stat-pill" style="background: #fef3c7;">
            ‚≠ê Premium
        </div>
        {% else %}
        <div class="stat-pill">
            <strong>{{ downloads_remaining }}</strong> restant{{ downloads_remaining|pluralize }}
        </div>
        {% endif %}
    </div>
</div>

<div class="filter-bar">
    <select class="filter-select" id="filterMatiere" onchange="filterDownloads()">
        <option value="">Toutes les mati√®res</option>
        {% for matiere in matieres_list %}
        <option value="{{ matiere }}">{{ matiere }}</option>
        {% endfor %}
    </select>
    
    <select class="filter-select" id="filterAnnee" onchange="filterDownloads()">
        <option value="">Toutes les ann√©es</option>
        {% for annee in annees_list %}
        <option value="{{ annee }}">{{ annee }}</option>
        {% endfor %}
    </select>
    
    <input type="text" class="search-input" placeholder="üîç Rechercher une √©preuve..." id="searchInput" onkeyup="filterDownloads()">
</div>

{% if downloads %}
    {% regroup downloads by downloaded_at|date:"F Y" as downloads_by_month %}
    
    {% for month in downloads_by_month %}
    <div class="month-section">
        <div class="month-header">
            <span class="month-title">{{ month.grouper }}</span>
            <span class="month-count">{{ month.list|length }} t√©l√©chargement{{ month.list|pluralize }}</span>
        </div>
        
        <div class="downloads-list">
            {% for download in month.list %}
            <div class="download-item" data-matiere="{{ download.matiere }}" data-annee="{{ download.annee }}" data-title="{{ download.epreuve_title|lower }}">
                <div class="download-icon {% if 'corrige' in download.epreuve_title|lower %}corrige{% endif %}">
                    {% if 'corrige' in download.epreuve_title|lower %}‚úÖ{% else %}üìÑ{% endif %}
                </div>
                
                <div class="download-info">
                    <div class="download-title">{{ download.epreuve_title }}</div>
                    <div class="download-meta">
                        <span>üìö {{ download.matiere }}</span>
                        <span>üéì {{ download.classe }}</span>
                        <span>üìÖ {{ download.annee }}</span>
                        <span>üïê {{ download.downloaded_at|date:"d/m/Y H:i" }}</span>
                    </div>
                </div>
                
                <span class="download-badge {% if download.is_free %}free{% else %}premium{% endif %}">
                    {% if download.is_free %}üÜì Gratuit{% else %}üíé Premium{% endif %}
                </span>
                
                <div class="download-actions">
                    <button class="btn-icon primary" onclick="reDownload({{ download.epreuve_id }})" title="T√©l√©charger √† nouveau">
                        ‚¨áÔ∏è
                    </button>
                    <button class="btn-icon" onclick="preview({{ download.epreuve_id }})" title="Aper√ßu">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    <!-- Pagination (si beaucoup de r√©sultats) -->
    {% if total_downloads > 20 %}
    <div class="pagination">
        <button class="page-btn" disabled>‚Üê Pr√©c√©dent</button>
        <button class="page-btn active">1</button>
        <button class="page-btn">2</button>
        <button class="page-btn">3</button>
        <button class="page-btn">Suivant ‚Üí</button>
    </div>
    {% endif %}
    
{% else %}
    <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <h3 class="empty-title">Aucun t√©l√©chargement</h3>
        <p class="empty-text">Tu n'as pas encore t√©l√©charg√© d'√©preuves. Commence ta r√©vision d√®s maintenant !</p>
        <a href="{% url 'dashboard:epreuves' %}" class="btn-primary" style="text-decoration: none;">
            üîç Explorer les √©preuves
        </a>
    </div>
{% endif %}

<script>
function filterDownloads() {
    const matiere = document.getElementById('filterMatiere').value.toLowerCase();
    const annee = document.getElementById('filterAnnee').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    document.querySelectorAll('.download-item').forEach(item => {
        const itemMatiere = item.dataset.matiere.toLowerCase();
        const itemAnnee = item.dataset.annee;
        const itemTitle = item.dataset.title;
        
        const matchMatiere = !matiere || itemMatiere === matiere;
        const matchAnnee = !annee || itemAnnee === annee;
        const matchSearch = !search || itemTitle.includes(search);
        
        item.style.display = matchMatiere && matchAnnee && matchSearch ? 'flex' : 'none';
    });
}

function reDownload(epreuveId) {
    // √Ä impl√©menter : redownload logic
    alert('Redownload de l\'√©preuve ' + epreuveId);
}

function preview(epreuveId) {
    // √Ä impl√©menter : preview modal
    alert('Aper√ßu de l\'√©preuve ' + epreuveId);
}
</script>
{% endblock %}